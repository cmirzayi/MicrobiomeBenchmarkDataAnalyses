---
title: "Analysis of the Cagaro dataset"
output: 
    html_document:
        toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE}
library(MicrobiomeBenchmarkData)
library(MicrobiomeBenchmarkDataAnalyses)
library(phyloseq)
library(mia)
library(benchdamic)
library(purrr)
```

# Import data

Dataset

```{r}
tse <- getDataset("HMP_2012_16S_gingival_V35_subset", dryrun = FALSE)[[1]]

## define helpful variables
grp <- "hmp_body_subsite"
conditions <- c(condB = "subgingival_plaque", condA = "supragingival_plaque")
```

# Analysis at the OTU level

Get prior knowledge (biological truth)

```{r}
row_data <- as.data.frame(rowData(tse))
taxaNames <- rownames(row_data)
newNames <- paste0(taxaNames, "|", row_data$GENUS) 
priorInfo <- data.frame(
    taxaNames = taxaNames,
    genus = row_data$GENUS,
    newNames = newNames,
    type = row_data$BIOSIS 
)

rownames(priorInfo) <- taxaNames
```

Convert to phyloseq

```{r}
ps <- makePhyloseqFromTreeSummarizedExperiment(tse)

## This step places the first condition as reference
sample_data(ps)[[grp]] <- factor(
    sample_data(ps)[[grp]], levels = conditions
)
ps
```

## Add normalization factors

```{r}
norm_par <- tibble::tribble(
    ~ fun, ~ method,
    "norm_edgeR", "TMM",
    "norm_edgeR", "none",
    "norm_DESeq2", "poscounts",
    "norm_CSS", "median"
)

norms <- setNormalizations(fun = norm_par$fun, method = norm_par$method)

ps <- 
    runNormalizations(normalization_list = norms, object = ps, verbose = FALSE)

colnames(sample_data(ps))
```


## Get TSS and CLR normalization

TSS normalization


```{r}
counts <- as(otu_table(ps), 'matrix')
counts_tss <- (apply(counts, 2, function(x) {
   x / sum(x) * 1e6
}))
summary(colSums(counts_tss))
```






## Estimate matrix of weights

This weights are only usedd by DESeq2, edgeR, and limma-voom to make them
compatible with scRNA-seq analysis.

```{r}

zinbWeights <- weights_ZINB(object = ps, design = grp)
dim(zinbWeights)
```


## Run DA methods

### DESeq2

```{r}
output_DESeq2 <- DA_DESeq2(
    object = ps, pseudo_count = FALSE, 
    design = as.formula(paste0("~", grp)),
    contrast = c(grp, conditions[2], conditions[1]), 
    norm = "poscounts", 
    verbose = FALSE
)

output_DESeq2_zinbweights <- DA_DESeq2(
    object = ps, pseudo_count = FALSE,
    design = as.formula(paste0("~", grp)),
    contrast = c(grp, conditions[2], conditions[1]),
    norm = "poscounts", weights = zinbWeights,
    verbose = FALSE
)
```

### edgeR

```{r}
output_edgeR <- DA_edgeR(
    object = ps, pseudo_count = FALSE, group_name = grp,
    design = as.formula(paste0("~", grp)), norm = "TMM",
    verbose = FALSE
)

output_edgeR_zinbweihgts <- DA_edgeR(
    object = ps, pseudo_count = FALSE, group_name = grp,
    design = as.formula(paste0("~", grp)), norm = "TMM",
    weights = zinbWeights,
    verbose = FALSE
)
```

### limma

```{r}
output_limma <- DA_limma(
    object = ps, pseudo_count = FALSE, design = grp, norm = "TMM",
    verbose = FALSE,
)

output_limma_zinbweights <- DA_limma(
   object = ps, pseudo_count = FALSE, design = grp, norm = "TMM" ,
   weights = zinbWeights, verbose = FALSE 
)
```

### ALDEx2

```{r}
output_aldex2_t <- DA_ALDEx2(
    object = ps, pseudo_count = FALSE, conditions = grp,
    test = "t", denom = "iqlr", norm = "none",
    verbose = FALSE
)

output_aldex2_wilcox <- DA_ALDEx2(
    object = ps, pseudo_count = FALSE, conditions = grp,
    test = "wilcox", denom = "iqlr", norm = "none",
    verbose = FALSE
)

```


### MetagenomeSeq

```{r}
# output_metagenomeseq <- DA_metagenomeSeq(
    # object = ps, design = grp, coef = 2, norm = "CSSmedian",
    # verbose = FALSE
# )
```
### Wilcox

```{r, warning=FALSE}
output_wilcox_none <- DA_wilcox(
    object = ps, norm = 'none', design = grp, denom = conditions[1]
)

output_wilcox_clr <- DA_wilcox(
    object = ps, norm = 'CLR', design = grp, denom = conditions[1]
)

output_wilcox_tss <- DA_wilcox(
    object = ps, norm = 'TSS', design = grp, denom = conditions[1]
)
```





### Combine DA results

```{r}
DA_results <- list(
    output_DESeq2,
    output_DESeq2_zinbweights,
    output_edgeR,
    output_edgeR_zinbweihgts,
    output_limma,
    output_limma_zinbweights,
    output_aldex2_t,
    output_aldex2_wilcox,
    output_wilcox_none,
    output_wilcox_clr,
    output_wilcox_tss
)
names(DA_results) <- map_chr(DA_results, ~ .x$name)

```

## Enrichment

### Direction

```{r}
direction <- c(
    DESeq2.poscounts = "log2FoldChange",
    DESeq2.poscounts.weighted = "log2FoldChange",
    edgeR.TMM = "logFC",
    edgeR.TMM.weighted = "logFC",
    limma.TMM = "logFC",
    limma.TMM.weighted = "logFC",
    output_aldex2_t = "effect",
    output_aldex2_wilcox = "effect",
    output_wilcox_none = "log2FoldChange",
    output_wilcox_clr = "log2FoldChange",
    output_wilcox_tss = "log2FoldChange"
)

```

### Calculate enrichment

```{r}
enrichment <- createEnrichment(
    object = DA_results,
    priorKnowledge = priorInfo,
    enrichmentCol = "type",
    namesCol = "newNames",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = NULL,
    alternative = "greater",
    verbose = FALSE 
)

```


### Plot enrichment

```{r}
enrich_plot <- plotEnrichment(
    enrichment = enrichment, 
    enrichmentCol = "type",
    levels_to_plot = c("Aerobic", "Anaerobic", "F Anaerobic")
)
enrich_plot

```

## Putative positives ratio

### Create table of putative positives

```{r}
positives <- createPositives(
    object = DA_results, 
    priorKnowledge = priorInfo, enrichmentCol = "type", namesCol = "newNames",
    slot = "pValMat", colName = "rawP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 1,
    threshold_logfc = 0,
    top = seq.int(from = 0, to = 50, by = 5),
    alternative = "greater",
    verbose = FALSE,
    TP = list(c("DOWN Abundant", "Anaerobic"), c("UP Abundant", "Aerobic")),
    FP = list(c("DOWN Abundant", "Aerobic"), c("UP Abundant", "Anaerobic"))
)
```


### Plot table of putative positives

```{r}
pos_plot <- plotPositives(positives)
pos_plot
```






