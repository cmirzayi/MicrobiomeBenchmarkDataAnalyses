---
title: "Ravel_2013_BV"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
library(SummarizedExperiment)
library(dplyr)
library(tidyr)
library(tibble)
library(purrr)
library(ggplot2)
```

The data comes from the article of Ravel et. al. 2013.

Reference:

Ravel, J., Brotman, R.M., Gajer, P. et al. Daily temporal dynamics of vaginal
microbiota before, during and after episodes of bacterial vaginosis.
Microbiome 1, 29 (2013). https://doi.org/10.1186/2049-2618-1-29

```{r}
se <- readRDS("Ravel_2013_BV_se.rds")
se
```

## Exploring sample metadata

```{r}
sample_metadata <- se %>% 
    colData() %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "Sample") %>% 
    as_tibble() %>% 
    mutate(
        subjectID = as.factor(subjectID),
        pH = as.double(pH),
        Nugent_Score = as.integer(Nugent_Score),
        amsel_pos = case_when(SBV == "1" | ABV == "1" ~ 1, TRUE ~ 0),
        amsel_res = case_when(
            SBV == "1" ~ "SBV", ABV == "1" ~ "ABV", TRUE ~ "Neg"
        ),
        nugent_res = case_when(
            Nugent_Score <= 3 ~ "Negative",
            Nugent_Score >=4 & Nugent_Score <= 6 ~ "Intermediate",
            Nugent_Score >= 7 ~ "Positive"
        ),
        nugent_res = factor(
          nugent_res, levels = c("Negative", "Intermediate", "Positive")
        )
    )
```

```{r}
glimpse(sample_metadata)
```

```{r}
sample_metadata %>% 
    count(subjectID, nugent_res, name = "count") %>% 
    # filter(nugent_res != "Intermediate") %>% 
    filter(!is.na(nugent_res)) %>%
    ggplot(aes(subjectID, count)) +
    geom_col(aes(fill = nugent_res), position = "stack") +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

Exploring the relationship between Nugent Scores and pH

```{r}
sample_metadata %>% 
    mutate(pH = as.double(pH), Nugent_Score = as.integer(Nugent_Score)) %>% 
    suppressWarnings() %>% 
    filter(!is.na(pH), !is.na(Nugent_Score)) %>% 
    ggplot(aes(Nugent_Score, pH )) +
    geom_boxplot(
        aes(group = Nugent_Score), fill = "gray80", 
        outlier.color = "red"
        ) +
    geom_point(size = .25, position = "jitter", shape = 1) +
    geom_smooth() +
    theme_bw()
```


### Select subjects

+ Keep only subjects from the same ethnical group (white):

```{r}
subjects_data <- sample_metadata %>% 
    select(subjectID, AGE, amsel_pos, ETHa) %>% 
    group_by(subjectID) %>%
    slice_max(order_by = amsel_pos, with_ties = FALSE) %>% 
    ungroup() %>% 
    filter(ETHa == 0)

subjects <- unique(subjects_data$subjectID)
```


```{r}
subjects_data %>% 
    modify_at(.at = c("subjectID", "amsel_pos", "ETHa"), .f = as.factor) %>% 
    summary()
```

According to the article, only four subjects never experienced some form of BV.
However, in the summary above there are five subjects.

```{r}
negative_subjects <- subjects_data %>% 
    filter(amsel_pos == 0) %>% 
    pull(subjectID)
negative_subjects
```

```{r}
sample_metadata %>% 
    filter(subjectID %in% negative_subjects) %>% 
    select(subjectID, SBV, ABV) %>% 
    distinct()
```

## Assays

```{r}
count_matrix <- assays(se)$counts
count_matrix[1:5, 1:5]
```


```{r}
relative_abundance_matrix <- assays(se)$relative_abundance
relative_abundance_matrix[1:5, 1:5]
```

```{r}
max(colSums(relative_abundance_matrix))
```

## Summarize by genus

```{r}
se_genus <- mia::agglomerateByRank(se, rank = "genus")
se_genus
```

Get taxonomy table: 

```{r}
taxa_genus <- se_genus %>% 
    rowData() %>% 
    as.data.frame %>% 
    rownames_to_column(var = "tax_name") %>% 
    as_tibble()
```

Combine sample metadata, relative abundance, and taxonomy into a single tibble:

```{r}
tidy_table_genus <- assays(se_genus)$relative_abundance %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "Taxa") %>% 
    as_tibble() %>% 
    pivot_longer(names_to = "Sample", values_to = "Abundance", 2:last_col()) %>% 
    left_join(sample_metadata, by = "Sample") %>% 
    right_join(taxa_genus, by = c("Taxa" = "tax_name")) %>% 
    relocate(Sample, Taxa, Abundance) %>% 
    filter(subjectID %in% subjects)
```


Nugent score vs relative abundance of Lactubacillus


```{r}
taxa_genera <- c(
    "Lactobacillus$",
    "Gardnerella$"
)
taxa_regex <- paste0("(", paste0(taxa_genera, collapse = "|"), ")")

tidy_table_genus %>% 
    filter(grepl(taxa_regex, Taxa)) %>%
    select(Sample, Taxa, Abundance, pH, Nugent_Score, nugent_res) %>% 
    mutate(
        Taxa = sub("^.+_", "", Taxa),
        Taxa = factor(Taxa, levels = sub("\\$$", "", taxa_genera)),
    ) %>% 
    drop_na() %>% 
    suppressWarnings() %>% 
    ggplot(aes(Nugent_Score, Abundance)) +
    geom_boxplot(
        aes(group = Nugent_Score, color = nugent_res), outlier.shape = 4
    ) +
    # geom_point(size = .25, position = "jitter") +
    geom_smooth(color = "red") +
    facet_wrap(~Taxa, ncol = 2) +
    scale_x_continuous(breaks = seq(0,10,1)) +
    scale_color_discrete(name = "BV diagnostic (Nugent score)") +
    labs(
        y = "Relative abundance", x = "Nugent score",
        title = "Full dataset (Ravel et. al., 2013)"
    ) +
    theme_bw() +
    theme(
        legend.position = "bottom"
    )
```

```{r}

```






