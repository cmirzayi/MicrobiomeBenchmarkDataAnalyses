---
title: "Ravel_2011_16S - Bacterial vaginosis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(MicrobiomeBenchmarkData)
# library(MicrobiomeBenchmarkDataAnalyses)
library(mia)
library(phyloseq)
library(dplyr)
library(benchdamic)
```


```{r}
dat_name <- 'Ravel_2011_16S_BV'
conditions_col <- 'nugent_score_category'
conditions <- c(condB = 'low', condA = 'high')

se <- getDataset(dat_name, dryrun = FALSE)[[1]]
se <- se[,colData(se)$nugent_score_category %in% c('low', 'high')]
se <- se[rowSums(assay(se)) > 1, colSums(assay(se)) != 0]
se
```

## Get prior Info by genus 

```{r}
priorInfo <- as.data.frame(subset(rowData(se), select = c('genus', 'Attribute')))
newNames <- paste0(rownames(priorInfo), '|', priorInfo$genus)
priorInfo <- priorInfo %>% 
    filter(!is.na(genus)) %>% 
    distinct()
rownames(priorInfo) <- priorInfo$genus
```

## Summarize by genus

```{r}
se_genus <- splitByRanks(se)$genus
se_genus
```

Reorder priorInfo according to rownames of se_genus


```{r}
ps <- makePhyloseqFromTreeSummarizedExperiment(se_genus)
sample_data(ps)[[conditions_col]] <- 
    factor(sample_data(ps)[[conditions_col]], levels = conditions)
```


## Run Differential abundance analysis

```{r}
ps <- filter_phyloseq(ps)
ps <- runNormalizations(set_norm_list(),ps)
zw <- weights_ZINB(ps, design = conditions_col)
DA_methods <- set_DA_methods_list(conditions_col, conditions)
DA_output <- runDA(DA_methods, ps, weights = zw, verbose = FALSE) 
```

