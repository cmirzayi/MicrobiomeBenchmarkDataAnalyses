---
title: "Ravel_2011_16S - Bacterial vaginosis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(MicrobiomeBenchmarkData)
library(MicrobiomeBenchmarkDataAnalyses)
library(mia)
library(phyloseq)
library(dplyr)
library(benchdamic)

library(ggplot2)

```


```{r}
dat_name <- 'Ravel_2011_16S_BV'
conditions_col <- 'study_condition'
conditions <- c(condB = 'healthy', condA = 'bacterial_vaginosis')

tse <- getDataset(dat_name, dryrun = FALSE)[[1]]
select_samples <- colData(tse)[[conditions_col]] %in% conditions
tse <- tse[, select_samples]
tse <- tse[rowSums(assay(tse)) > 1,] 
tse
```

```{r}
table(colData(tse)$study_condition)
```


## Get prior Info by genus 

```{r}
priorInfo <- 
    as.data.frame(subset(rowData(tse), select = c('genus', 'taxon_annotation')))
newNames <- paste0(rownames(priorInfo), '|', priorInfo$genus)
priorInfo <- priorInfo %>% 
    filter(!is.na(genus)) %>% 
    distinct()
rownames(priorInfo) <- priorInfo$genus
head(priorInfo)
```

## Summarize by genus

```{r}
tse_genus <- splitByRanks(tse)$genus
tse_genus
```

Reorder priorInfo according to rownames of se_genus


```{r}
ps <- makePhyloseqFromTreeSummarizedExperiment(tse_genus)
sample_data(ps)[[conditions_col]] <- 
    factor(sample_data(ps)[[conditions_col]], levels = conditions)
```


## Run Differential abundance analysis

Filter

```{r}
ps <- filter_phyloseq(ps)
```

DA analysis:

```{r, message=FALSE}
ps <- runNormalizations(set_norm_list(),ps, verbose = FALSE)
zw <- weights_ZINB(ps, design = conditions_col)
DA_methods <- set_DA_methods_list(conditions_col, conditions)

DA_methods$DA_ALDEx2.1 <- NULL
DA_methods <- purrr::discard(DA_methods, is.null)
```

```{r}
fname <- paste0('./', dat_name, '.rds')
fname2 <- paste0('../../misc/articles_data/', dat_name, '.rds')
if (file.exists(fname)) {
    message('DA output exists in current directory. Importing...')
    DA_output <- readRDS(fname)
} else if (file.exists(fname2)) {
    message('DA ouptut exists in misc directory. Importing...')
    DA_output <- readRDS(fname2)
} else {
    DA_output <- runDA(DA_methods, ps, weights = zw, verbose = FALSE) 
    saveRDS(DA_output, fname)
} 
```

See results

```{r}
names(DA_output)
```

Get significant taxa (pvalues and adj pvalues) and direction (effect size):

```{r}
dir_cols <- get_direction_cols(DA_output, conditions_col, conditions)

output <- vector('list', length(DA_output))
names(output) <- names(DA_output)

for (i in seq_along(output)) {
    output_name <- names(dir_cols)[i]
    col_name <- dir_cols[i]
    statInfo <- DA_output[[output_name]]$statInfo
    statInfo <- statInfo[, c(col_name), drop = FALSE]
    pValMat <- DA_output[[output_name]]$pValMat
    df <- cbind(statInfo, pValMat)
    df <- df %>% 
        as.data.frame() %>% 
        tibble::rownames_to_column(var = 'taxon_name') %>% 
        as_tibble() %>% 
        magrittr::set_colnames(c('taxon_id', 'effect_size', 'rawP', 'adjP')) 
    output[[i]] <- df
}

output <- bind_rows(output, .id = 'method')
```


Lactobacillus should be less abundante in all bacterial vaginosis samples

```{r}
lactobacillus <- output %>% 
    dplyr::filter(taxon_id == 'Lactobacillus') 
DT::datatable(lactobacillus)
```

```{r}
lactobacillus %>% 
    ggplot(aes(method, effect_size)) +
    geom_point(aes(color = rawP)) +
    scale_colour_viridis_b() + 
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

```{r}
lactobacillus %>% 
    ggplot(aes(method, effect_size)) +
    geom_point(aes(color = adjP)) +
    scale_colour_viridis_b() + 
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

```{r}
increased_abundance_rawp <- output %>% 
    dplyr::filter(
        rawP <= 0.05, effect_size > 0
    ) %>% 
    left_join(priorInfo, by = c('taxon_id' = 'genus')) %>% 
    dplyr::filter(
        taxon_annotation == 'bv-associated'
    )
```


## Increased abundance of hv-associated


```{r}
increased_abundance_adjp <- output %>% 
    dplyr::filter(
        adjP <= 0.1, effect_size > 0
    ) %>% 
    left_join(priorInfo, by = c('taxon_id' = 'genus')) %>% 
    dplyr::filter(
        taxon_annotation == 'bv-associated'
    )
```


```{r}
increased_abundance_adjp %>% 
    count(method) %>% 
    ggplot(aes(method,sort(n))) +
    geom_col(color = 'black', alpha = 0.3) +
    scale_y_continuous(limits = c(0, 11), breaks = seq(0, 10, 2)) +
    labs(
        x = 'DA methods', y = 'Number of detected BV-associated taxa'
    ) +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```


