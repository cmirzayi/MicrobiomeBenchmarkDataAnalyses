---
title: "HMP_16S_gingival_subset"
output:
  html_document:
    toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE 
)
```

# Introduction

Analysis of the `HMP_16S_gingival_subset` dataset.

```{r}
library(MicrobiomeBenchmarkData)
library(MicrobiomeBenchmarkDataAnalyses)
library(mia)
library(benchdamic)
library(phyloseq)
```

Some useful variables:

```{r}
grp <- "grp"
conditions <- c("subgingival_plaque", "supragingival_plaque")
```

# Import data

```{r import dataset}
dataset_name <- "HMP_2012_16S_gingival_V35_subset"
tse <- getDataset(dataset_name, dryrun = FALSE)[[1]]
colData(tse)$grp <- factor(colData(tse)$hmp_body_subsite, levels = conditions)
tse
```

Get dataset summarized by genus:

```{r}
tse_ranks <- splitByRanks(tse)
tse_genus <- tse_ranks$GENUS
tse_genus
```

# Analysis at the OTU level

## Prior knowledge

```{r prior knowledge}
priorInfo <- as.data.frame(rowData(tse)[,c("GENUS", "BIOSIS")])
priorInfo[["newNames"]] <- 
  paste0(rownames(priorInfo), "|", priorInfo$GENUS)
priorInfo[["Type"]] <- 
  ifelse(is.na(priorInfo$BIOSIS), "unknown", priorInfo$BIOSIS)
head(priorInfo)
```

## Convert to phyloseq

```{r convert to phyloseq}
ps <- makePhyloseqFromTreeSummarizedExperiment(tse)
sample_data(ps)[[grp]] <- factor(sample_data(ps)[[grp]])
## Reference is subgingival plaque (conditions[1])
sample_data(ps)[[grp]] <- relevel(sample_data(ps)[[grp]], conditions[1])
ps
```

## Run DA methods

```{r}
## Add normalization factors
ps <- quiet(runNormalizations(normalization_methods_list, ps))

## Calculate weights
# zinbweights <- weights_ZINB(ps, design = "~ 1", K = 0)

## Run DA methods
DA_methods_list <- set_DA_methods_list(grp, conditions)
DA <- quiet(runDA(DA_methods_list, ps, weights = NULL))
str(DA, max.level = 1)
```

## Enrichment

Prepare directions for enrichment:

```{r direction}
## This most be in the same order
direction <- c(
    edgeR.TMM = "logFC", 
    DESeq2.poscounts = "log2FoldChange",
    limma.CSSmedian = "logFC",
    limma.TMM = "logFC",
    metgenomeSeq.CSSmedian = paste0(grp, conditions[2]),
    ALDEx2.none = "effect",
    corncob.none = "Estimate",
    MAST.none = "logFC",
    Seurat.none = "avg_log2FC",
    ZINQ = "log2FoldChange",
    ANCOMBC = "logFC",
    wilcox_test = "log2FoldChange",
    wilcox_test_clr = "log2FoldChange",
    kruskal_test = "log2FoldChange",
    kruskal_test_clr = "log2FoldChange"
)
```

Run enrichment: 

```{r create enrichment}
enrichment <- createEnrichment(
    object = DA,
    priorKnowledge = priorInfo,
    enrichmentCol = "Type",
    namesCol = "newNames",
    slot = "pValMat",
    colName = "adjP",
    type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = NULL,
    alternative = "greater",
    verbose = TRUE
)
```

Plot enrichment:

```{r, fig.height=7}
plotEnrichment(
    enrichment = enrichment, 
    enrichmentCol = "Type",
    levels_to_plot = c("Aerobic", "Anaerobic", "F Anaerobic")
)

```

## Putative true positives - putative false positives

```{r create positives}
positives <- createPositives(
    object = DA, 
    priorKnowledge = priorInfo,
    enrichmentCol = "Type",
    namesCol = "newNames",
    slot = "pValMat",
    colName = "rawP",
    type = "pvalue",
    direction = direction,
    threshold_pvalue = 1,
    threshold_logfc = 0,
    top = seq.int(from = 0, to = 50, by = 5),
    alternative = "greater",
    verbose = FALSE,
    TP = list(c("DOWN Abundant", "Anaerobic"), c("UP Abundant", "Aerobic")),
    FP = list(c("DOWN Abundant", "Aerobic"), c("UP Abundant", "Anaerobic"))
)

head(positives)
```

Plot positives

```{r}
ggp <- plotPositives(positives)
ggp
```







