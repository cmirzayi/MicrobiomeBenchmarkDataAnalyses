---
title: "HMP_16S_gingival_subset"
output:
  html_document:
    toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE
)
```

```{r setup}
library(benchdamic)
library(phyloseq)
library(MicrobiomeBenchmarkData)
library(MicrobiomeBenchmarkDataAnalyses)
library(dplyr)
```

Some useful variables:

```{r useful variables}
grp <- "grp"
contrast <- c("subgingival_plaque", "supragingival_plaque")
```

## Import dataset

```{r import dataset}
dataset_name <- "HMP_2012_16S_gingival_V35_subset"
tse <- getDataset(dataset_name, dryrun = FALSE)[[1]]
## a grp column is created as a copy of the hmp_body_subsite column
colData(tse)$grp <- factor(colData(tse)$hmp_body_subsite, levels = contrast)
```

## benchdamic pipeline

In this document, we use the [benchdamic package](https://bioconductor.org/packages/devel/bioc/html/benchdamic.html)
for benchmarking different differential abundance (DA) methods using the
`r dataset_name`.

### Create prior knowledge information

```{r prior knowledge}
priorInfo <- as.data.frame(rowData(tse)[,c("GENUS", "BIOSIS")])
priorInfo$newNames <- 
  paste0(rownames(priorInfo), "|", priorInfo$GENUS)
priorInfo$Type <- 
  ifelse(is.na(priorInfo$BIOSIS), "unknown", priorInfo$BIOSIS)
head(priorInfo)
```

### Convert to phyloseq

```{r convert to phyloseq}
## Biosis information is lost at this step, but it's already stored in the
## priorInfo variable
ps <- mia::makePhyloseqFromTreeSummarizedExperiment(tse)
```

Set reference:
```{r set reference}
## Using subgingival plaque as reference (contast[1])
sample_data(ps)[[grp]] <- factor(sample_data(ps)[[grp]])
sample_data(ps)[[grp]] <- relevel(x = sample_data(ps)[[grp]], ref = contrast[1])
```

### Run DA methods

```{r}
## Add normalization factors
ps <- runNormalizations(
  normalization_list = normalization_methods_list, object = ps
) %>% 
  quiet()

## Calculate weights
zinbweights <- weights_ZINB(
    object = ps,
    K = 0,
    design = "~ 1"
)

## Run DA methods
DA_methods_list <- set_DA_methods_list(
  grp = grp, contrast = contrast
)
DA <- runDA(
  method_list = DA_methods_list, object = ps, weights = zinbweights
) %>% 
  quiet()

str(DA, max.level = 1)
```

### Enrichment

Prepare directions (for enrichment):

```{r direction}
## This most be in the same order
direction <- c(
    edgeR.TMM = "logFC", 
    DESeq2.poscounts = "log2FoldChange",
    limma.CSSmedian = "logFC",
    limma.TMM = "logFC",
    metgenomeSeq.CSSmedian = paste0(grp, contrast[2]),
    ALDEx2.none = "effect",
    corncob.none = "Estimate",
    MAST.none = "logFC",
    Seurat.none = "avg_log2FC",
    ZINQ = "log2FoldChange",
    ANCOMBC = "logFC",
    wilcox_test = "log2FoldChange",
    wilcox_test_clr = "log2FoldChange"
)
```

Run enrichment: 

```{r create enrichment}
enrichment <- createEnrichment(
    object = DA,
    priorKnowledge = priorInfo,
    enrichmentCol = "Type",
    namesCol = "newNames",
    slot = "pValMat",
    colName = "adjP",
    type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = NULL,
    alternative = "greater",
    verbose = TRUE
)
```

Plot enrichment:

```{r, fig.height=7}
plotEnrichment(
    enrichment = enrichment, 
    enrichmentCol = "Type",
    levels_to_plot = c("Aerobic", "Anaerobic", "F Anaerobic")
)

```

### TRUE and FALSE positives

Create table of positives

```{r create positives}
positives <- createPositives(
    object = DA, 
    priorKnowledge = priorInfo,
    enrichmentCol = "Type",
    namesCol = "newNames",
    slot = "pValMat",
    colName = "rawP",
    type = "pvalue",
    direction = direction,
    threshold_pvalue = 1,
    threshold_logfc = 0,
    top = seq.int(from = 0, to = 50, by = 5),
    alternative = "greater",
    verbose = FALSE,
    TP = list(c("DOWN Abundant", "Anaerobic"), c("UP Abundant", "Aerobic")),
    FP = list(c("DOWN Abundant", "Aerobic"), c("UP Abundant", "Anaerobic"))
)

head(positives)
```

Plot positives

```{r}
ggp <- plotPositives(positives)
ggp
```







