---
title: "Analysis of the Sammler_2016_16S_spikein dataset"
subtitle: "Comparison of coefficient of variation"
output:
    html_document:
        toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(MicrobiomeBenchmarkDataAnalyses)
library(MicrobiomeBenchmarkData)
library(dplyr)
library(tibble)
library(tidyr)
library(biobroom)
library(ggplot2)
```

# Source code

[Source](https://waldronlab.io/MicrobiomeBenchmarkDataAnalyses/articles/Stammler_2016_16S_spikein.html)

# Data

```{r, message=FALSE, warning=FALSE}
tse <- getBenchmarkData('Stammler_2016_16S_spikein', dryrun = FALSE)[[1]]
```

## Recalibrate with spike-in Salinibacter ruber

```{r}
spk_bac <- c(
    `S. ruber` = 'AF323500XXXX', 
    `R. radiobacter` = 'AB247615XXXX',
    `A. acidiphilus` = 'AB076660XXXX'
)

counts <- assay(tse, 'counts')
s_ruber <- counts[spk_bac['S. ruber'], ]

size_factor <- s_ruber/mean(s_ruber)
SCML_data <- counts 
for(i in seq(ncol(SCML_data))){
    SCML_data[,i] <- round(SCML_data[,i] / size_factor[i])
}

assay(tse, 'counts_recal') <- SCML_data
```

## Tranform counts and recalibrated counts with TSS (relative abundance) and CLR

```{r}
tss_fun <- function(x) (x + 1) / sum((x + 1))
clr_fun <- function(x) (x + 1) / exp(mean(log((x + 1))))

## TSS - original counts
assay(tse, "TSS") <- apply(assay(tse, 'counts'), 2,  tss_fun)

## CLR - original counts
assay(tse, "CLR") <- apply(assay(tse, 'counts'), 2, clr_fun) 

## TSS - recalibrated counts
assay(tse, "TSS_recal") <- apply(assay(tse, 'counts_recal'), 2, tss_fun)

## CLR - recalibrated counts
assay(tse, "CLR_recal") <- apply(assay(tse, 'counts_recal'), 2, clr_fun)
```

# Extract data of sipike-in bacteria

```{r}
spk_bac_tse <- tse[spk_bac,]
rownames(spk_bac_tse) <- names(spk_bac)
spk_bac_tse
```

# Get tidy data

```{r, message=FALSE, warning=FALSE}
## sample metadata
col_data <- tse %>% 
    colData() %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "sample") %>% 
    as_tibble() %>% 
    select(sample, subject_id, study_condition)

## data for relative abundance
output <- vector("list", length(assays(spk_bac_tse)))
for (i in seq_along(output)) {
    data_name <- names(assays(spk_bac_tse))[i]
    names(output)[i] <- data_name
    output[[i]] <- tidy.RangedSummarizedExperiment(
        spk_bac_tse, assay = data_name
    ) %>% 
        magrittr::set_colnames(c('taxon', 'sample', data_name))
}
data <- purrr::reduce(output, left_join) %>% 
    left_join(col_data) %>% 
    relocate(subject_id, study_condition, .after = sample)

DT::datatable(data, filter = 'top')
```

# Calculate coefficient of variation

## Define formula for calculating coefficient of variation

```{r}
get_cv <- function(x) {
    cv <- function(x, n) { sd(x[n]) / mean(x[n]) * 100 } 
    boot::boot(x, cv, R = 1000) |>
        broom::tidy() |>
        dplyr::rename(cv = statistic)
} 
```

```{r}
cv_res <- data %>% 
    group_by(taxon) %>% 
    summarize(across(.cols = counts:last_col(), .fns = get_cv)) %>% 
    pivot_longer(
        cols = 2:last_col(), names_to = 'norm', values_to = 'cv_res' 
    ) %>% 
    unnest(cols = 'cv_res')
   
DT::datatable(cv_res, filter = 'top')     
```


# Compare coefficient of variation

```{r, fig.width=8, fig.height=4}
cv_res %>% 
    mutate(
        recal = ifelse(grepl('recal', norm), 'Recalibrated', 'Original'),
        norm = factor(norm, levels = sort(unique(norm)))
    ) %>% 
    ggplot(aes(norm, cv)) +
    geom_col(
        aes(color = recal), position = position_dodge(), alpha = 0, size = 1
    ) + 
    geom_errorbar(
        aes(ymin = cv - std.error, ymax = cv + std.error, color = recal),
        width = 0.4, size = 1
    ) +
    scale_color_brewer(type = 'qual', palette = 'Dark2') +
    facet_wrap(~taxon) + 
    labs(
        y = 'Coefficient of variation',
        x = 'Data type'
    ) + 
    theme_bw() + 
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank(),
        strip.text = element_text(face = 'italic'),
        legend.title = element_blank()
    )
```






