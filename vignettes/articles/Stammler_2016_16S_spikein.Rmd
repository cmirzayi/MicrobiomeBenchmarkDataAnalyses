---
title: "Analysis of the Stammler_2016_16S_spikein dataset"
output: 
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r setup}
library(MicrobiomeBenchmarkData)
library(MicrobiomeBenchmarkDataAnalyses)
library(dplyr)
library(benchdamic)
library(phyloseq)
library(purrr)
```


## Import data 

```{r}
dat_name <- 'Stammler_2016_16S_spikein'
tse <- getDataset(dat_name, dryrun = FALSE)[[1]]
tse
```

## Spike-in bacteria identifiers

| Bacteria | ID | Load |
| -------- | -- | ---- |
| *Salinibacter ruber* | AF323500XXXX | 3.0 x 10<sup>8</sup> |
| *Rhizobium radiobacter* | AB247615XXXX | 5.0 x 10<sup>8</sup> |
| *Alicyclobacillus acidiphilus* | AB076660XXXX | 1.0 x 10<sup>8</sup> |


```{r}
spikein_bacteria <- c(
    s_ruber = 'AF323500XXXX', 
    r_radiobacter = 'AB247615XXXX',
    a_acidiphilus = 'AB076660XXXX'
)
```


## Recalibrate counts based on Salinibacter ruber

```{r}
counts <- assay(tse)
## AF323500XXXX is the unique OTU corresponding to S. ruber
s_ruber <- counts['AF323500XXXX', ]
size_factor <- s_ruber/mean(s_ruber)

counts_recal <- counts 
for(i in seq(ncol(counts_recal))){
    counts_recal[,i] <- round(counts_recal[,i] / size_factor[i])
}

tse_recal <- tse
assay(tse_recal) <- counts_recal
```

# Subset samples - preASCT vs d14

```{r}
## Variables for conditions
conditions_col <- 'study_condition'
conditions <- c(condB = 'preASCT', condA = 'd14')

## Select samples
select_samples <- colData(tse)[[conditions_col]] %in% conditions

## Raw read counts
tse <- tse[, select_samples]
tse <- tse[rowSums(assay(tse)) > 0, ]

## Recalibrated counts
tse_recal <- tse_recal[, select_samples]
tse_recal <- tse_recal[rowSums(assay(tse_recal)) > 0, ]

```

# Convert to phyloseq

```{r}
## Convert raw counts to phyloseq
ps <- mia::makePhyloseqFromTreeSummarizedExperiment(tse)
sample_data(ps)[[conditions_col]] <- factor(
    sample_data(ps)[[conditions_col]], levels = conditions
)
ps <- filter_phyloseq(ps)

## Convert recalibrated counts to phyloseq

ps_recal <- mia::makePhyloseqFromTreeSummarizedExperiment(tse_recal)
sample_data(ps_recal)[[conditions_col]] <- factor(
    sample_data(ps_recal)[[conditions_col]], levels = conditions
)
ps_recal <- filter_phyloseq(ps_recal)
```


# Run DA

Run DA for raw counts

```{r}

DA_output_file <-  paste0('./', dat_name, '.rds')
DA_output_flie_2 <- paste0('../../misc/articles_data/', dat_name, '.rds')

if (file.exists(DA_output_file)) {
    message('DA results exist in directory. Importing...')
    DA_output <- readRDS(DA_output_file)
} else if (file.exists(DA_output_flie_2)) {
    message('DA results exist in misc. Importing')
    DA_output <- readRDS(DA_output_flie_2)
} else if (!file.exists(DA_output_file)) {
    message('Performing DA results.')
    DA_output <- run_DA(ps, conditions_col, conditions)
    saveRDS(DA_output, DA_output_file) 
}

```

Run DA for recalibrated counts

```{r}
DA_output_file_recal <-  paste0('./', dat_name, '_recal.rds')
DA_output_flie_2_recal <-
    paste0('../../misc/articles_data/', dat_name, '_recal.rds')

if (file.exists(DA_output_file_recal)) {
    message('DA results exist in directory. Importing...')
    DA_output_recal <- readRDS(DA_output_file_recal)
} else if (file.exists(DA_output_flie_2_recal)) {
    message('DA results exist in misc. Importing')
    DA_output_recal <- readRDS(DA_output_flie_2_recal)
} else if (!file.exists(DA_output_file_recal)) {
    message('Performing DA results.')
    DA_output_recal <- run_DA(ps_recal, conditions_col, conditions)
    saveRDS(DA_output_recal, DA_output_file_recal) 
}

```

## Comparing results of DA

Get results with raw counts

```{r}

dir_cols <- get_direction_cols(DA_output, conditions_col, conditions)

output <- vector('list', length(DA_output))
names(output) <- names(DA_output)

for (i in seq_along(output)) {
    output_name <- names(dir_cols)[i]
    col_name <- dir_cols[i]
    statInfo <- DA_output[[output_name]]$statInfo
    statInfo <- statInfo[, c(col_name), drop = FALSE]
    pValMat <- DA_output[[output_name]]$pValMat
    df <- cbind(statInfo, pValMat)
    df <- df %>% 
        as.data.frame() %>% 
        tibble::rownames_to_column(var = 'taxon_name') %>% 
        as_tibble() %>% 
        magrittr::set_colnames(c('taxon_id', 'effect_size', 'rawP', 'adjP')) 
    output[[i]] <- df
}

output <- bind_rows(output, .id = 'method')

```


Get results with recalibrated counts

```{r}
dir_cols_recal <-
    get_direction_cols(DA_output_recal, conditions_col, conditions)

output_recal <- vector('list', length(DA_output_recal))
names(output_recal) <- names(DA_output_recal)

for (i in seq_along(output_recal)) {
    output_name <- names(dir_cols_recal)[i]
    col_name <- dir_cols_recal[i]
    statInfo <- DA_output_recal[[output_name]]$statInfo
    statInfo <- statInfo[, c(col_name), drop = FALSE]
    pValMat <- DA_output_recal[[output_name]]$pValMat
    df <- cbind(statInfo, pValMat)
    df <- df %>% 
        as.data.frame() %>% 
        tibble::rownames_to_column(var = 'taxon_name') %>% 
        as_tibble() %>% 
        magrittr::set_colnames(c('taxon_id', 'effect_size', 'rawP', 'adjP')) 
    output_recal[[i]] <- df
}

output_recal <- bind_rows(output_recal, .id = 'method')
```

## Compare results


```{r}
output %>% 
    dplyr::filter(
        taxon_id %in% spikein_bacteria,
        # grepl('^(wilcox)', method)
        rawP <= 0.05
    )
```

```{r}
output_recal %>% 
    dplyr::filter(
        taxon_id %in% spikein_bacteria,
        # grepl('^(wilcox)', method)
         rawP <= 0.05
    )
```

# count of salnibacter

Compare with normalization 

```{r}
assay(tse)[spikein_bacteria['s_ruber'], ]
```

```{r}
sd(assay(tse_recal)[spikein_bacteria['s_ruber'], ])
```

# counts of Alicyclobacillus acidiphilus

```{r}
sd(assay(tse)[spikein_bacteria['a_acidiphilus'], ])
```

```{r}
sd(assay(tse_recal)[spikein_bacteria['a_acidiphilus'], ])
```


# counts of 

```{r}
sd(assay(tse)[spikein_bacteria['r_radiobacter'], ])

```

```{r}
sd(assay(tse_recal)[spikein_bacteria['r_radiobacter'], ])

```

```{r}
spikein_bacteria
```

