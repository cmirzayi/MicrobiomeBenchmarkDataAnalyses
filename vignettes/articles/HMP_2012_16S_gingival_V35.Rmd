---
title: "HMP_2012_16S_gingival_V35 - supgragingival vs sugingival plaque"
output:
    html_document:
        toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r setup}
library(MicrobiomeBenchmarkDataAnalyses)
library(MicrobiomeBenchmarkData)
library(mia)
library(phyloseq)
library(magrittr)
library(benchdamic)

library(dplyr)
library(ggplot2)
library(gridExtra)
```

# Data

Import dataset:

```{r import data}
dat_name <- 'HMP_2012_16S_gingival_V35'
conditions_col <- 'body_subsite'
conditions <- c(condB = 'subgingival_plaque', condA = 'supragingival_plaque')

tse <- getBenchmarkData(dat_name, dryrun = FALSE)[[1]]
tse
```
Filter data

+ Subjects from the same run center and the first visit.

```{r filter data}
col_data <- as.data.frame(colData(tse))
col_data_sub <-
    dplyr::filter(col_data, run_center == 'WUGC', visit_number == 1)
col_data_split <- split(col_data_sub, factor(col_data_sub$body_subsite))
subjects <- intersect(
    col_data_split$subgingival_plaque$subject_id,
    col_data_split$supragingival_plaque$subject_id
)

male_subjects <- dplyr::filter(
    col_data_sub,
    subject_id %in% subjects, gender == 'male'
) %>% 
    dplyr::pull(subject_id) %>% 
    unique()

female_subjects <- dplyr::filter(
    col_data_sub,
    subject_id %in% subjects, gender == 'female'
) %>% 
    dplyr::pull(subject_id) %>% 
    unique()
n <- min(length(male_subjects), length(female_subjects))
set.seed(1234)
select_subjects <- c(sample(male_subjects, n), sample(female_subjects, n))
select_samples <- rownames(col_data_sub)[
    col_data_sub$subject_id %in% select_subjects
]
tse_subset <- tse[,select_samples]
tse_subset <- filterTaxa(tse_subset)

colData(tse_subset)[[conditions_col]] <- 
    factor(colData(tse_subset)[[conditions_col]], levels = conditions)

tse_subset
```

# Prior information

OTU level:

```{r prior information}
row_data <- as.data.frame(rowData(tse_subset))
prior_info <- row_data[, c('genus', 'taxon_annotation')]
prior_info$taxon_name <- rownames(row_data)
prior_info$new_names <- paste0(prior_info$taxon_name, '|', prior_info$genus)
prior_info <- 
    dplyr::relocate(prior_info, taxon_name, new_names, genus, taxon_annotation)
head(prior_info)
```

# Benchmarking at the OTU level

Convert to phyloseq

```{r}
ps <- makePhyloseqFromTreeSummarizedExperiment(tse_subset)
sample_data(ps)[[conditions_col]] <- 
    factor(sample_data(ps)[[conditions_col]], levels = conditions)
ps
```

## Differential abundance analysis

```{r run DA, warning=FALSE, message=FALSE}
time_start <- Sys.time()
DA_output <- run_DA(ps, conditions_col, conditions)
time_end <- Sys.time()
elapsed_time <- time_end - time_start
elapsed_time
```

# Enrichment analysis

Get direction 

```{r}
direction <- get_direction_cols(DA_output, conditions_col, conditions)
```

## Enrichment (FDR <= 0.1)

```{r}
enrichment <- createEnrichment(
    object = DA_output,
    priorKnowledge = prior_info,
    enrichmentCol = "taxon_annotation",
    namesCol = "new_names",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = NULL, # No top feature selected
    alternative = "greater",
    verbose = FALSE 
)
```

## Plot enrichment

```{r, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
enrich_plot <- plot_enrichment(
    enrichment = enrichment, 
    enrichment_col = "taxon_annotation",
    levels_to_plot = c("aerobic", "anaerobic", "facultative_anaerobic"),
    conditions = conditions
)
enrich_plot +
    labs(y = "Number of OTUs")

```

# Putative true positives - putative false positives

## Calculate TP - FP ratio (no threshold)

```{r}
positives <- createPositives(
    object = DA_output, 
    priorKnowledge = prior_info, 
    enrichmentCol = "taxon_annotation", namesCol = "new_names",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 1,
    threshold_logfc = 0,
    top = seq.int(from = 0, to = 50, by = 5),
    alternative = "greater",
    verbose = FALSE,
    TP = list(c("DOWN Abundant", "anaerobic"), c("UP Abundant", "aerobic")),
    FP = list(c("DOWN Abundant", "aerobic"), c("UP Abundant", "anaerobic"))
) |> 
    left_join(get_meth_class(), by = 'method')
```

## Plot TP - FP 

```{r, fig.width=10, fig.height=6}
positive_plots <- plot_positives(positives)
grid.arrange(grobs = positive_plots, ncol = 3)
```

```{r}
sessionInfo()
```

