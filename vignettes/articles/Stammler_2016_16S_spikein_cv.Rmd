---
title: "Analysis of the Sammler_2016_16S_spikein dataset II"
subtitle: "Coefficient of variation and plots of abundance values"
output:
    html_document:
        toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(MicrobiomeBenchmarkDataAnalyses)
library(MicrobiomeBenchmarkData)
library(dplyr)
library(tibble)
library(tidyr)
library(biobroom)
library(ggplot2)
```

# Import data

```{r}
tse <- getBenchmarkData('Stammler_2016_16S_spikein', dryrun = FALSE)[[1]]
```

# Normalize data with TSS (relative abundance) and CLR

TSS

```{r}
assays(tse)[[2]] <- apply(assays(tse)[[1]] + 1, 2, function(x) {
    x / sum(x)
})
names(assays(tse))[2] <- 'TSS'
```

CLR

```{r}
assays(tse)[[3]] <- apply(assays(tse)[[1]] + 1, 2, function(x) {
    x / exp(mean(log(x)))
})
names(assays(tse))[3] <- 'CLR'
```

# Extract data of sipike-in bacteria

```{r}
spk_bac <- c(
    `S. ruber` = 'AF323500XXXX', 
    `R. radiobacter` = 'AB247615XXXX',
    `A. acidiphilus` = 'AB076660XXXX'
)

spk_bac_tse <- tse[spk_bac,]
rownames(spk_bac_tse) <- names(spk_bac)
rownames(spk_bac_tse)
```

```{r}
spk_bac_tse
```

# Get tidy data

Get sample metadata (for both TSS and CLR):

```{r, message=FALSE, warning=FALSE}
## col data for both TSS and CLR
col_data <- spk_bac_tse %>% 
    colData() %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "sample") %>% 
    as_tibble() %>% 
    select(sample, subject_id, study_condition)

## data for relative abundance
tss_data <- tidy.RangedSummarizedExperiment(spk_bac_tse, assay = "TSS") %>% 
    rename(taxon = gene) %>% 
    right_join(col_data)

## data for CLR
clr_data <- tidy.RangedSummarizedExperiment(spk_bac_tse, assay = "CLR") %>% 
    rename(taxon = gene) %>% 
    right_join(col_data)

data <- bind_rows(list(TSS = tss_data, CLR = clr_data), .id = 'norm') %>% 
    mutate(norm = ifelse(norm == 'TSS', 'TSS (relative abundance)', norm))

DT::datatable(data, filter = 'top')
```




# Calculate coefficient of variation

## Define function for CV

```{r}
get_cv <- function(df) {
    cv <- function(x, n) { sd(x[n]) / mean(x[n]) * 100 } 
    df |> 
        {\(y) split(y, factor(y$taxon))}() |>
        # lapply(., function(x) split(x, x$study_condition)) %>% 
        # unlist(recursive = FALSE) %>% 
        lapply(function(x) boot::boot(x$value, cv, R = 1000)) |>
        lapply(function(x) broom::tidy(x)) |>
        dplyr::bind_rows(.id = 'taxon') |>
        dplyr::rename(cv = statistic)
}
```

## Coefficient of variation (all study conditions, preASCT, d0, d7, d14)

```{r}
cv_data <- data %>% 
    split(factor(.$norm)) %>% 
    lapply(get_cv) %>% 
    bind_rows(.id = 'norm')
DT::datatable(cv_data, filter = 'top')
```

```{r}
cv_data %>% 
    ggplot(aes(taxon, cv, color = norm)) +
    geom_col(position = position_dodge(1), alpha = 0, size = 1) +
    geom_errorbar(
        aes(min = cv - std.error, max = cv + std.error, color = norm),
        position = position_dodge(1), width = 0.2, size = 1
    ) + 
    labs(
        x = "Spike-in bacteria",
        y = "Coefficient of variation"
    ) +
    theme_bw() +
    theme(axis.text.x = element_text(face = 'italic'))

```



## Coefficient of variation (only preASCT and d14 study conditions)

```{r}
cv_data_2 <- data %>% 
    filter(study_condition %in% c('preASCT', 'd14')) %>%
    split(factor(.$norm)) %>% 
    lapply(get_cv) %>% 
    bind_rows(.id = 'norm') 
DT::datatable(cv_data_2, filter = 'top')
```


```{r}
cv_data_2 %>% 
    ggplot(aes(taxon, cv, color = norm)) +
    geom_col(position = position_dodge(1), alpha = 0, size = 1) +
    geom_errorbar(
        aes(min = cv - std.error, max = cv + std.error, color = norm),
        position = position_dodge(1), width = 0.2, size = 1
    ) + 
    labs(
        x = "Spike-in bacteria",
        y = "Coefficient of variation"
    ) +
    theme_bw() +
    theme(axis.text.x = element_text(face = 'italic'))

```

# Plots of abundance values for the three spike-in bacteria

```{r, message=FALSE, fig.height=9, fig.width=9}
p <- data %>% 
    mutate(
        study_condition = factor(
            study_condition, levels = c('preASCT', 'd0', 'd7', 'd14') 
        )
    ) %>% 
    arrange(study_condition) %>% 
    mutate(sample = forcats::fct_inorder(sample)) %>% 
    ggplot(aes(sample, value)) + 
    geom_point(
        aes(fill = study_condition), size = 3, shape = 21, color = 'black'
    ) +
    facet_wrap(~taxon+norm, ncol = 2, scales = "free") +
    labs(
        title = 'Comparison of CLR and relative abundance values',
        x = 'Abundance value',
        y = 'Sample name'
    ) +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
p
```

```{r, include=FALSE, echo=FALSE, eval=FALSE}
ggsave(filename = "Spikein.png", plot = p, width = 9, height = 9)
```

