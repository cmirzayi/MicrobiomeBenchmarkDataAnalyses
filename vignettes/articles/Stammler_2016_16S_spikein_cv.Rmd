---
title: "Analysis of the Sammler_2016_16S_spikein dataset"
subtitle: "Coefficient of variation"
output:
    html_document:
        toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(MicrobiomeBenchmarkDataAnalyses)
library(MicrobiomeBenchmarkData)
library(dplyr)
library(tibble)
library(tidyr)
library(boot)
```

# Import data

```{r}
tse <- getBenchmarkData('Stammler_2016_16S_spikein', dryrun = FALSE)[[1]]
```

# Normalize data with TSS (relative abundance) and CLR

TSS

```{r}
assays(tse)[[2]] <- apply(assays(tse)[[1]], 2, function(x) {
    x / sum(x) * 1e6
})
names(assays(tse))[2] <- 'TSS'
```

CLR

```{r}
assays(tse)[[3]] <- apply(assays(tse)[[1]] + 1, 2, function(x) {
    log(x / exp(mean(log(x))))
})
names(assays(tse))[3] <- 'CLR'
```

# Extract data of sipike-in bacteria

```{r}
spk_bac <- c(
    s_ruber = 'AF323500XXXX', 
    r_radiobacter = 'AB247615XXXX',
    a_acidiphilus = 'AB076660XXXX'
)

spk_bac_tse <- tse[spk_bac,]
rownames(spk_bac_tse) <- names(spk_bac)
rownames(spk_bac_tse)
```

```{r}
spk_bac_tse
```

# Get tidy data

Get sample metadata (for both TSS and CLR):

```{r}
col_data <- spk_bac_tse %>% 
    colData() %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "sample_id") %>% 
    as_tibble() %>% 
    select(sample_id, subject_id, study_condition)

```

TSS

```{r}
tss_data <- assays(spk_bac_tse)$TSS %>% 
    as.data.frame() %>% 
    rownames_to_column("taxon_id") %>% 
    as_tibble() %>% 
    pivot_longer(
        cols = 2:last_col(), names_to = "sample_id", values_to = "abundance"
    ) %>% 
    left_join(col_data, by = 'sample_id')
head(tss_data)
```

CLR

```{r}
clr_data <- assays(spk_bac_tse)$CLR %>% 
    as.data.frame() %>% 
    rownames_to_column("taxon_id") %>% 
    as_tibble() %>% 
    pivot_longer(
        cols = 2:last_col(), names_to = "sample_id", values_to = "abundance"
    ) %>% 
    left_join(col_data, by = 'sample_id')
head(clr_data)
```

# Calculate coefficient of variation

## Define function for CV

```{r}
get_cv <- function(df) {
    ## an internal function for calculating cv
    cv <- function(x, n) { sd(x[n]) / mean(x[n]) * 100 } 
    
    x <- df |> 
        {\(y) split(y, factor(y$taxon_id))}() |>
        # lapply(., function(x) split(x, x$study_condition)) %>% 
        # unlist(recursive = FALSE) %>% 
        lapply(function(x) boot::boot(x$abundance, cv, R = 1000))
    
    res <- data.frame(
        bac = names(x),
        original_cv = vapply(x, function(x) x$t0, double(1)),
        mean_cv = vapply(x, function(x) mean(x$t), double(1)),
        sd_cv = vapply(x, function(x) sd(x$t), double(1)),
        ## Calculate bis by resting the mean minus original
        bias_cv = vapply(x, function(x) mean(x$t[,1]) - x$t0[1], double(1))
    )
    
    rownames(res) <- NULL
    dplyr::as_tibble(res)
}
```

## Coefficient of variation (all study conditions, preASCT, d0, d7, d14)

### Relative abudance (TSS)

```{r}
tss_data %>% 
    get_cv() %>% 
    knitr::kable()
```

### CLR

```{r}
clr_data %>% 
    get_cv() %>% 
    knitr::kable()
```

## Coefficient of variation (only preASCT and d14 study conditions)

### Relative abundance (TSS)

```{r}
tss_data %>% 
    filter(study_condition %in% c('preASCT', 'd14')) %>%
    get_cv() %>% 
    knitr::kable()
```

### CLR (TSS)

```{r}
clr_data %>% 
    filter(study_condition %in% c('preASCT', 'd14')) %>%
    get_cv() %>% 
    knitr::kable()
```

