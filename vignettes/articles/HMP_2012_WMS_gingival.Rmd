---
title: "Analysis of the HMP_2012_WMS_gingiva dataset"
output: 
    html_document:
        toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r, message=FALSE}
library(MicrobiomeBenchmarkData)
library(MicrobiomeBenchmarkDataAnalyses)
library(phyloseq)
library(mia)
library(benchdamic)
library(purrr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(randomcoloR)
library(tibble)
```

# Import data

Dataset

```{r}
dat_name <- 'HMP_2012_WMS_gingival'
conditions_col <- "body_subsite"
conditions <- c(condB = "subgingival_plaque", condA = "supragingival_plaque")

tse <- getDataset(dat_name, dryrun = FALSE)[[1]]
rownames(tse) <- sub("^.*s__", "", rownames(tse))
```

# Analysis at the species level

Import biosis annotations:

```{r}
biosis_file <- system.file(
  "extdata/nychanes_biosis.tsv", 
  package = "MicrobiomeBenchmarkDataAnalyses"
)
biosis <- read.table(biosis_file, header = TRUE, sep = "\t")
```

Create priorInfo data

```{r}
row_data <- as.data.frame(rowData(tse))
priorInfo <- left_join(row_data, biosis, by = c("genus" = "genera")) %>% 
    select(species, biosis) 
rownames(priorInfo) <- rownames(row_data)
colnames(priorInfo) <- c("taxaNames", "type")
priorInfo$newNames <- rownames(priorInfo)
```

Convert to phyloseq

```{r}
ps <- makePhyloseqFromTreeSummarizedExperiment(tse)
ps <- filter_phyloseq(ps)
sample_data(ps)[[conditions_col]] <- factor(
    sample_data(ps)[[conditions_col]], levels = conditions
)
ps
```


```{r}
DA_output <- run_DA(
    object = ps, conditions_col = conditions_col, conditions = conditions
)
```

# Exploratory plots of the DA outputs

## P-value distribution

```{r}
priorInfo$type <- ifelse(is.na(priorInfo$type), "NA", priorInfo$type)
pvalue_plots <- map2(DA_output, names(DA_output), ~ {
    rownames_to_column(.x$pValMat, var = 'taxa') %>%
        as_tibble() %>% 
        left_join(priorInfo, by = c('taxa' = 'newNames')) %>% 
        ggplot(aes(x = rawP, fill = type)) +
        geom_histogram(bins = 20, color = 'black') +
        scale_x_continuous(limits = c(-0.05, 1.05)) +
        ggtitle(.y) +
        theme_bw()
})
```

```{r}
pvalue_plots
```


## Histogram of adjusted P-values

```{r}

fdr_plots <- map2(DA_output, names(DA_output), ~ {
    rownames_to_column(.x$pValMat, var = 'taxa') %>%
        as_tibble() %>% 
        left_join(priorInfo, by = c('taxa' = 'newNames')) %>% 
        ggplot(aes(x = adjP, fill = type)) +
        geom_histogram(bins = 20, color = 'black') +
        scale_x_continuous(limits = c(-0.05, 1.05)) +
        ggtitle(.y) +
        theme_bw()
})

```

```{r}
fdr_plots
```

# Enrichment

Get direction 

```{r}
direction <- get_direction_cols(DA_output, conditions_col, conditions)
```

## Enrichment (adjP >= 0.1)

```{r}
enrichment <- createEnrichment(
    object = DA_output,
    priorKnowledge = priorInfo,
    enrichmentCol = "type",
    namesCol = "newNames",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = NULL, # No top feature selected
    alternative = "greater",
    verbose = FALSE 
)
```

## Plot enrichment

```{r, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
enrich_plot <- plot_enrichment(
    enrichment = enrichment, 
    enrichment_col = "type",
    levels_to_plot = c("Aerobic", "Anaerobic", "F Anaerobic"),
    conditions = conditions
)
enrich_plot

```

# Putative true positives - putative false positives

## Calculate TP - FP ratio (adP <= 0.1)

```{r}
positives <- createPositives(
    object = DA_output, 
    priorKnowledge = priorInfo, enrichmentCol = "type", namesCol = "newNames",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.2,
    threshold_logfc = 0,
    top = seq.int(from = 0, to = 50, by = 5),
    alternative = "greater",
    verbose = FALSE,
    TP = list(c("DOWN Abundant", "Anaerobic"), c("UP Abundant", "Aerobic")),
    FP = list(c("DOWN Abundant", "Aerobic"), c("UP Abundant", "Anaerobic"))
)
```

## Plot TP - FP 

```{r}
meth_class <- get_meth_class() 
positives2 <- left_join(meth_class, positives, by = 'method') %>% 
    relocate(method_class)
```


```{r, fig.height = 12, fig.width=10}
plots <- plot_positives(positives2)
grid.arrange(grobs = plots, ncol = 2)

```

