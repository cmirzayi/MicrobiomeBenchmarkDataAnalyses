---
title: "Analysis of the HMP_2012_WMS_gingiva dataset"
output: 
    html_document:
        toc: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r}

library(MicrobiomeBenchmarkDataAnalyses)
library(MicrobiomeBenchmarkData)
library(mia)
library(benchdamic)
library(dplyr)
library(ggplot2)
library(gridExtra)
```


# Import data

```{r}
dat_name <-'HMP_2012_WMS_gingival'
tse <- getBenchmarkData(dat_name, dryrun = FALSE)[[1]]
tse
```

# Prior knowledge

```{r}
row_data <- as.data.frame(rowData(tse))
prior_info <- row_data[, c('genus', 'taxon_annotation')]
prior_info$taxon_name <- rownames(prior_info)
prior_info$new_names <- paste0(prior_info$taxon_name, '|', prior_info$genus)
head(prior_info)
```

# Convert to phyloseq

```{r}
ps <- makePhyloseqFromTreeSummarizedExperiment(tse)
ps <- filter_phyloseq(ps)
phyloseq::sample_data(ps)$body_subsite <- 
    factor(phyloseq::sample_data(ps)$body_subsite)
ps
```

# Run DA

```{r, message=TRUE}
conditions_col <- 'body_subsite'
conditions <- c(condB = 'subgingival_plaque', condA = 'supragingival_plaque')

## This can take a while. It's better to save the results and import them back
## later
DA_output_file <-  paste0('./', dat_name, '.rds')
DA_output_flie_2 <- paste0('../../misc/articles_data/', dat_name, '.rds')

if (file.exists(DA_output_file)) {
    message('DA results exist in directory. Importing...')
    DA_output <- readRDS(DA_output_file)
} else if (file.exists(DA_output_flie_2)) {
    message('DA results exist in misc. Importing')
    DA_output <- readRDS(DA_output_flie_2)
} else if (!file.exists(DA_output_file)) {
    message('Performing DA results.')
    DA_output <- run_DA(ps, conditions_col, conditions)
    saveRDS(DA_output, DA_output_file) 
}

```


```{r}
names(DA_output)
```

# Enrichment

Get direction 

```{r}
direction <- get_direction_cols(DA_output, conditions_col, conditions)
```

## Enrichment (adjP >= 0.1)

```{r}
enrichment <- createEnrichment(
    object = DA_output,
    priorKnowledge = prior_info,
    enrichmentCol = "taxon_annotation",
    namesCol = "taxon_name",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = NULL, # No top feature selected
    alternative = "greater",
    verbose = FALSE 
)
```

## Plot enrichment

```{r, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
enrich_plot <- plot_enrichment(
    enrichment = enrichment, 
    enrichment_col = "taxon_annotation",
    levels_to_plot = c("aerobic", "anaerobic", "facultative_anaerobic"),
    conditions = conditions
)
enrich_plot

```

# Putative true positives - putative false positives

## Calculate TP - FP ratio (adP <= 0.1)

```{r}
positives <- createPositives(
    object = DA_output, 
    priorKnowledge = prior_info, 
    enrichmentCol = "taxon_annotation", namesCol = "taxon_name",
    slot = "pValMat", colName = "adjP", type = "pvalue",
    direction = direction,
    threshold_pvalue = 0.1,
    threshold_logfc = 0,
    top = seq.int(from = 0, to = 50, by = 5),
    alternative = "greater",
    verbose = FALSE,
    TP = list(c("DOWN Abundant", "anaerobic"), c("UP Abundant", "aerobic")),
    FP = list(c("DOWN Abundant", "anaerobic"), c("UP Abundant", "anaerobic"))
)
```

## Plot TP - FP 

```{r}
meth_class <- get_meth_class() 
positives2 <- left_join(meth_class, positives, by = 'method') %>% 
    relocate(method_class)
```


```{r, fig.height = 12, fig.width=10}
plots <- plot_positives(positives2)
grid.arrange(grobs = plots, ncol = 2)

```
